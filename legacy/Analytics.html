<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      color: #333;
      padding: 15px;
      background: #f5f5f5;
    }

    .header {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
      padding: 20px;
      margin: -15px -15px 20px -15px;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 12px;
    }

    .section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #17a2b8;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #17a2b8;
      transition: transform 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .metric-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #17a2b8;
    }

    .metric-unit {
      font-size: 14px;
      color: #666;
      margin-left: 3px;
    }

    .chart-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .bar-chart {
      margin-top: 15px;
    }

    .bar-item {
      margin-bottom: 12px;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
    }

    .bar-label-text {
      font-weight: 600;
      color: #333;
    }

    .bar-label-value {
      color: #666;
    }

    .bar-track {
      height: 25px;
      background: #e9ecef;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-size: 12px;
      font-weight: bold;
      transition: width 0.5s ease;
    }

    .pie-chart {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 15px;
    }

    .pie-legend {
      width: 100%;
      margin-top: 15px;
    }

    .legend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 4px;
      background: #f8f9fa;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 10px;
    }

    .legend-label {
      flex: 1;
      font-size: 13px;
    }

    .legend-value {
      font-weight: bold;
      margin-left: 10px;
      color: #17a2b8;
    }

    .legend-percent {
      font-size: 12px;
      color: #666;
      margin-left: 5px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .table th {
      background: #17a2b8;
      color: white;
      padding: 10px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
    }

    .table td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 13px;
    }

    .table tr:hover {
      background: #f8f9fa;
    }

    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
      width: 100%;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-info:hover {
      background: #138496;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: #666;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      font-size: 13px;
    }

    .summary-label {
      color: #666;
    }

    .summary-value {
      font-weight: bold;
      color: #17a2b8;
    }

    .color-active { background: #28a745; }
    .color-complete { background: #dc3545; }
    .color-onhold { background: #ffc107; }
    .color-1 { background: #17a2b8; }
    .color-2 { background: #6c757d; }
    .color-3 { background: #28a745; }
    .color-4 { background: #ffc107; }
    .color-5 { background: #dc3545; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Batch Analytics</h1>
    <p>Statistical analysis and insights</p>
  </div>

  <div class="metric-grid" id="metricsGrid">
    <div class="metric-card">
      <div class="metric-label">Total Batches</div>
      <div class="metric-value" id="totalBatches">-</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Total Weight</div>
      <div class="metric-value">
        <span id="totalWeight">-</span>
        <span class="metric-unit">T</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Consumed</div>
      <div class="metric-value">
        <span id="consumedWeight">-</span>
        <span class="metric-unit">T</span>
      </div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Remaining</div>
      <div class="metric-value">
        <span id="remainingWeight">-</span>
        <span class="metric-unit">T</span>
      </div>
    </div>
  </div>

  <div class="chart-container">
    <div class="section-title">Batch Status Distribution</div>
    <div class="pie-legend" id="statusChart">
      <div class="loading">Loading status data</div>
    </div>
  </div>

  <div class="chart-container">
    <div class="section-title">Weight by Product</div>
    <div class="bar-chart" id="productChart">
      <div class="loading">Loading product data</div>
    </div>
  </div>

  <div class="chart-container">
    <div class="section-title">Weight by Variant</div>
    <div class="bar-chart" id="variantChart">
      <div class="loading">Loading variant data</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Product Summary</div>
    <div id="productSummary">
      <div class="loading">Loading summary</div>
    </div>
  </div>

  <div class="section">
    <button class="btn btn-info" onclick="refreshAnalytics()">Refresh Analytics</button>
  </div>

  <script>
    let statisticsData = {};

    window.onload = function() {
      loadAnalytics();
    };

    function loadAnalytics() {
      google.script.run
        .withSuccessHandler(displayAnalytics)
        .withFailureHandler(showError)
        .getBatchStatistics();
    }

    function displayAnalytics(stats) {
      statisticsData = stats;

      // Update metrics
      document.getElementById('totalBatches').textContent = stats.total || 0;
      document.getElementById('totalWeight').textContent = (stats.totalWeight || 0).toFixed(2);
      document.getElementById('consumedWeight').textContent = (stats.consumedWeight || 0).toFixed(2);
      document.getElementById('remainingWeight').textContent = (stats.remainingWeight || 0).toFixed(2);

      // Render charts
      renderStatusChart(stats.byStatus);
      renderProductChart(stats.byProduct);
      renderVariantChart(stats.byVariant);
      renderProductSummary(stats.byProduct);
    }

    function renderStatusChart(statusData) {
      const container = document.getElementById('statusChart');

      if (!statusData || Object.keys(statusData).length === 0) {
        container.innerHTML = '<div class="empty-state">No status data available</div>';
        return;
      }

      const total = Object.values(statusData).reduce((sum, count) => sum + count, 0);

      const statusColors = {
        'ACTIVE': 'color-active',
        'COMPLETE': 'color-complete',
        'ON_HOLD': 'color-onhold'
      };

      const statusLabels = {
        'ACTIVE': 'Active',
        'COMPLETE': 'Complete',
        'ON_HOLD': 'On Hold'
      };

      let html = '';
      Object.entries(statusData).forEach(([status, count]) => {
        const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        html += `
          <div class="legend-item">
            <div style="display: flex; align-items: center; flex: 1;">
              <div class="legend-color ${statusColors[status] || 'color-1'}"></div>
              <span class="legend-label">${statusLabels[status] || status}</span>
            </div>
            <span class="legend-value">${count}</span>
            <span class="legend-percent">(${percent}%)</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderProductChart(productData) {
      const container = document.getElementById('productChart');

      if (!productData || Object.keys(productData).length === 0) {
        container.innerHTML = '<div class="empty-state">No product data available</div>';
        return;
      }

      // Sort by weight descending
      const sortedProducts = Object.entries(productData)
        .sort((a, b) => b[1].totalWeight - a[1].totalWeight);

      const maxWeight = Math.max(...sortedProducts.map(([_, data]) => data.totalWeight));

      let html = '';
      sortedProducts.forEach(([product, data]) => {
        const widthPercent = maxWeight > 0 ? (data.totalWeight / maxWeight * 100) : 0;
        const remaining = data.remainingWeight || 0;

        html += `
          <div class="bar-item">
            <div class="bar-label">
              <span class="bar-label-text">${product}</span>
              <span class="bar-label-value">${data.count} batches</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width: ${widthPercent}%">
                ${data.totalWeight.toFixed(2)}T
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderVariantChart(variantData) {
      const container = document.getElementById('variantChart');

      if (!variantData || Object.keys(variantData).length === 0) {
        container.innerHTML = '<div class="empty-state">No variant data available</div>';
        return;
      }

      // Sort by weight descending
      const sortedVariants = Object.entries(variantData)
        .sort((a, b) => b[1].totalWeight - a[1].totalWeight);

      const maxWeight = Math.max(...sortedVariants.map(([_, data]) => data.totalWeight));

      let html = '';
      sortedVariants.forEach(([variant, data]) => {
        const widthPercent = maxWeight > 0 ? (data.totalWeight / maxWeight * 100) : 0;

        html += `
          <div class="bar-item">
            <div class="bar-label">
              <span class="bar-label-text">${variant}</span>
              <span class="bar-label-value">${data.count} batches</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width: ${widthPercent}%">
                ${data.totalWeight.toFixed(2)}T
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderProductSummary(productData) {
      const container = document.getElementById('productSummary');

      if (!productData || Object.keys(productData).length === 0) {
        container.innerHTML = '<div class="empty-state">No product data available</div>';
        return;
      }

      // Sort by count descending
      const sortedProducts = Object.entries(productData)
        .sort((a, b) => b[1].count - a[1].count);

      let html = '<div class="summary-grid">';

      sortedProducts.forEach(([product, data]) => {
        const consumedPercent = data.totalWeight > 0
          ? (((data.totalWeight - data.remainingWeight) / data.totalWeight) * 100).toFixed(1)
          : 0;

        html += `
          <div class="summary-row">
            <span class="summary-label"><strong>${product}</strong></span>
            <span class="summary-value">${data.count} batches, ${data.totalWeight.toFixed(2)}T total</span>
          </div>
          <div class="summary-row" style="margin-top: -5px; margin-bottom: 10px;">
            <span class="summary-label">Remaining:</span>
            <span class="summary-value">${data.remainingWeight.toFixed(2)}T (${consumedPercent}% consumed)</span>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    function refreshAnalytics() {
      loadAnalytics();
    }

    function showError(error) {
      alert('Error loading analytics: ' + error.message);
      console.error(error);
    }
  </script>
</body>
</html>
